# Copyright 2022 Canonical Ltd.
# See LICENSE file for licensing details.
name: tempo-k8s
type: charm

assumes:
  - k8s-api

  # Juju 3.4.0 needed for pebble notify
  - juju >= 3.4.0

description: |
  Tempo is a distributed tracing backend by Grafana, supporting Jaeger,
  Zipkin, and OpenTelemetry protocols.

summary: |
  Tempo is a distributed tracing backend by Grafana.

links:
  documentation: https://discourse.charmhub.io/t/tempo-k8s-docs-index/14005
  website:
    - https://charmhub.io/tempo-k8s
  source:
    - https://github.com/canonical/tempo-k8s-operator
  issues:
    - https://github.com/canonical/tempo-k8s-operator/issues

containers:
  tempo:
    resource: tempo-image
    mounts:
      - storage: data
        location: /tmp/tempo

resources:
  tempo-image:
    type: oci-image
    description: OCI image for Tempo
    # Included for simplicity in integration tests
    # see https://hub.docker.com/r/grafana/tempo/tags
    upstream-source: grafana/tempo:2.4.0

provides:
  profiling-endpoint:
    interface: parca_scrape
  grafana-dashboard:
    interface: grafana_dashboard
  grafana-source:
    interface: grafana_datasource
  metrics-endpoint:
    interface: prometheus_scrape
  tracing:
    interface: tracing

requires:
  logging:
    interface: loki_push_api
  ingress:
    interface: traefik_route
    limit: 1

storage:
  data:
    type: filesystem
    location: /tempo-data

actions:
  list-receivers:
    description: |
      Returns a list of all enabled receiver endpoints.


bases:
  - build-on:
      - name: "ubuntu"
        channel: "22.04"
    run-on:
      - name: "ubuntu"
        channel: "22.04"

parts:
  charm:
    charm-binary-python-packages:
      - "pydantic>=2"
      - "opentelemetry-exporter-otlp-proto-http==1.21.0"

